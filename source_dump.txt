# ==================================================
# Path: E:\HTMLCSS\THUC_CHIEN\Thuc_Chien_11_Project_Cuoi_Khoa\server
# Detected tech: javascript, typescript
# ==================================================

## DIRECTORY STRUCTURE
```
server/
‚îú‚îÄ‚îÄ .git/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ v1/
‚îÇ       ‚îú‚îÄ‚îÄ controllers/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ city.controller.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ company.controller.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cv.controller.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ job.controller.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ tag.controller.js
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user.controller.js
‚îÇ       ‚îú‚îÄ‚îÄ middlewares/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ auth.middleware.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ optional-auth.middleware.js
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user-auth.middleware.js
‚îÇ       ‚îú‚îÄ‚îÄ models/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ city.model.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ company.model.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cv.model.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ job.model.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ otp.model.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ reset-token.model.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ tag.model.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ user-cv.model.js
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user.model.js
‚îÇ       ‚îú‚îÄ‚îÄ routes/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ city.route.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ company.route.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cv.route.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ index.route.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ job.route.js
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ tag.route.js
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ user.route.js
‚îÇ       ‚îî‚îÄ‚îÄ validators/
‚îÇ           ‚îú‚îÄ‚îÄ company.validator.js
‚îÇ           ‚îú‚îÄ‚îÄ cv.validator.js
‚îÇ           ‚îú‚îÄ‚îÄ job.validator.js
‚îÇ           ‚îî‚îÄ‚îÄ user.validator.js
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.js
‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îú‚îÄ‚îÄ generate.js
‚îÇ   ‚îî‚îÄ‚îÄ sendMail.js
‚îú‚îÄ‚îÄ middlewares/
‚îú‚îÄ‚îÄ node_modules/
‚îú‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ index.js
‚îú‚îÄ‚îÄ package-lock.json
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ source_dump.txt
```

## FILE CONTENTS

### index.js
```js
const express = require("express");
require("dotenv").config();
const app = express();
const database = require("./config/database");
const cookieParser = require("cookie-parser");
const port = process.env.PORT || 3000;

const cors = require("cors");

// K·∫øt n·ªëi database
database.connect();

// Middleware ƒë·ªÉ ƒë·ªçc body t·ª´ client, kh√¥ng c·∫ßn body-parser n√¢ng cao
app.use(express.json()); // ƒê·ªçc JSON t·ª´ client (axios/fetch g·ª≠i l√™n)
app.use(express.urlencoded({ extended: true })); // N·∫øu d√πng form HTML g·ª≠i l√™n

app.use(cookieParser());

//  Cho ph√©p CORS
app.use(
  cors({
    origin: ["http://localhost:3000", "https://project-it-job-react.vercel.app"], // ‚úÖ Ch·ªâ cho ph√©p React app
    credentials: true, //Cho ph√©o g·ª≠i request v·ªõi cookie, ph·∫£i c√≥
  })
); //  c·∫•u h√¨nh m·∫∑c ƒë·ªãnh: cho ph√©p t·∫•t c·∫£ origin
const routesApiV1 = require("./api/v1/routes/index.route");
routesApiV1(app);
// T∆∞∆°ng lai: th√™m v2
//const routesApiV2 = require("./api/v2/routes/index.route");  // üëâ index.route.js
//routesApiV2(app);

app.listen(port, () => {
  console.log(`App listening on port ${port}`);
});

```

### api\v1\controllers\city.controller.js
```js
const City = require("../models/city.model");
//[GET] /api/v1/city
module.exports.index = async (req, res) => {
    try {
        const citys = await City.find({});
        res.status(200).json(citys);
    } catch (error) {
        res.status(500).json(error);   
    }
}
```

### api\v1\controllers\company.controller.js
```js
const Company = require("../models/company.model");
const Otp = require("../models/otp.model");
const ResetToken = require("../models/reset-token.model");
const Job = require("../models/job.model");
const CV = require("../models/cv.model");
const md5 = require("md5");
const sendMailHelper = require("../../../helpers/sendMail");
const generateHelper = require("../../../helpers/generate");

//[GET] /api/v1/companys
module.exports.index = async (req, res) => {
  try {
    const companys = await Company.find({ deleted: false }).select(
      " -password -token"
    );
    res.status(200).json(companys);
  } catch (error) {
    res.status(500).json(error);
  }
};

//[GET] /api/v1/companys/info/:id
module.exports.info = async (req, res) => {
  try {
    const company = await Company.findOne({
      _id: req.params.id,
      deleted: false,
    }).select("-password -token");
    res.json(company);
  } catch (error) {
    res.status(500).json("LoÃÇÃÉi server");
  }
};

//[POST] /api/v1/companys/auth/login
module.exports.login = async (req, res) => {
  try {
    const company = await Company.findOne({
      email: req.body.email,
      deleted: false,
    });
    if (!company) {
      return res.status(400).json({ message: "TaÃÄi khoaÃân khoÃÇng toÃÇÃÄn taÃ£i" });
    }
    if (company.password !== md5(req.body.password)) {
      return res.status(400).json({ message: "Sai maÃ£ÃÇt khaÃÇÃâu" });
    }
    const token = company.token;
    res.cookie("token", token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production", // production th√¨ secure: true
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    res.json({ code: 200, message: "Login thaÃÄnh coÃÇng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[GET] /api/v1/company/auth/logout
module.exports.logout = async (req, res) => {
  try {
    res.clearCookie("token", {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
    });
    res.json({ code: 200, message: "Logout thaÃÄnh coÃÇng" });
  } catch (error) {
    res.status(500).json(error);
  }
};

//[POST] /api/v1/companys/auth/register
module.exports.register = async (req, res) => {
  try {
    //1. L·∫•y th√¥ng tin ng∆∞·ªùi d√πng
    const { phone, email, password, companyName } = req.body;
    //2. Ki·ªÉm tra t·ªìn t·∫°i
    const checkCompany = await Company.findOne({
      $or: [{ phone }, { email }, { companyName }],
    });
    // B√°o l·ªói ƒë√£ t·ªìn t·∫°i
    if (checkCompany?.email === email) {
      return res.status(400).json({ message: "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng" });
    }
    if (checkCompany?.phone === phone) {
      return res.status(400).json({ message: "S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng" });
    }

    //3. T·∫°o ng∆∞·ªùi d√πng nh∆∞ng ch∆∞a duy·ªát
    req.body.password = md5(password);
    req.body.deleted = true;
    const company = new Company(req.body);
    await company.save();
    //4. T·∫°o otp v√† g·ª≠i mail;
    const otpRandom = generateHelper.generateRandomNumber();
    const otbObject = {
      email: email,
      otp: otpRandom,
      type: "register",
      expiresAt: Date.now(),
    };
    const otp = new Otp(otbObject);
    await otp.save();
    const subject = "IT JOB - M√£ OTP x√°c minh t√†i kho·∫£n";
    sendMailHelper.sendMail(email, subject, otpRandom);
    res.json({
      code: 200,
      message: "ƒêaÃÜng kyÃÅ thaÃÄnh coÃÇng, vui l√≤ng x√°c minh t√†i kho·∫£n",
      email: email,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[POST] /api/v1/companys/auth/register/checkEmailOtp
module.exports.checkEmailOtp = async (req, res) => {
  try {
    const { email, otp } = req.body;
    if (!otp) {
      return res.status(400).json({ message: "Vui l√≤ng nh·∫≠p otp" });
    }
    const otpCheck = await Otp.findOne({
      email: email,
      otp: otp,
      type: "register",
    });
    if (!otpCheck) {
      return res.status(400).json({ message: "Kh√¥ng t√¨m th·∫•y otp" });
    }
    const company = await Company.findOne({ email: email });
    if (!company) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    const token = generateHelper.generateToken();
    company.token = token;
    company.deleted = false;
    await company.save();
    await Otp.findOneAndDelete({ email: email });
    res.cookie("token", token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production", // production th√¨ secure: true
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    res.status(200).json({ code: 200, message: "X√°c minh th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[POST] /api/v1/companys/auth/register/cancelRegister
module.exports.cancelRegister = async (req, res) => {
  try {
    const { email } = req.body;
    const company = await Company.findOne({ email: email, deleted: true });
    if (!company) {
      return res.status(400).json({ message: "Email kh√¥ng t·ªìn t·∫°i" });
    }
    await Company.findOneAndDelete({ email: email, deleted: true });
    await Otp.findOneAndDelete({ email: email });
    res.status(200).json({ code: 200, message: "H·ªßy ƒëƒÉng k√Ω th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[POST] /api/v1/companys/auth/register/resendCheckEmailOtp
module.exports.resendCheckEmailOtp = async (req, res) => {
  try {
    const { email } = req.body;
    const company = await Company.findOne({ email: email });
    if (!company) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    if (company.deleted === false) {
      return res
        .status(400)
        .json({ message: "T√†i kho·∫£n n√†y ƒë√£ ƒë∆∞·ª£c x√°c minh" });
    }
    const otp = generateHelper.generateRandomNumber();
    await Otp.findOneAndDelete({ email: email, type: "register" });

    const otbObject = {
      email: email,
      otp: otp,
      type: "register",
      expiresAt: Date.now(),
    };
    const otpCheck = new Otp(otbObject);
    await otpCheck.save();
    const subject = "IT JOB - M√£ OTP x√°c minh t√†i kho·∫£n";
    sendMailHelper.sendMail(email, subject, otp);
    return res.status(200).json({ code: 200, message: "M√£ OTP m·ªõi ƒë∆∞·ª£c g·ª≠i" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[GET] /api/v1/companys/me
module.exports.detail = async (req, res) => {
  try {
    res.json({
      code: 200,
      message: "ThaÃÄnh coÃÇng",
      company: req.company,
    });
  } catch (error) {
    res.status(500).json(error);
  }
};

//[PATCH] /api/v1/companys/me/edit
module.exports.edit = async (req, res) => {
  try {
    if (req.body.quantityPeople) {
      const people = Number(req.body.quantityPeople);

      // N·∫øu kh√¥ng ph·∫£i s·ªë ho·∫∑c l√† NaN
      if (!Number.isFinite(people)) {
        return res.status(400).json({ message: "S·ªë l∆∞·ª£ng nh√¢n s·ª± ph·∫£i l√† s·ªë" });
      }

      if (people <= 0) {
        return res
          .status(400)
          .json({ message: "S·ªë l∆∞·ª£ng nh√¢n s·ª± ph·∫£i l·ªõn h∆°n 0" });
      }
    }

    const company = await Company.findOneAndUpdate(
      { _id: req.company._id },
      req.body,
      { new: true }
    );
    res.json({ code: 200, message: "CaÃ£ÃÇp nhaÃ£ÃÇt thaÃÄnh coÃÇng", company: company });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[DELETE] /api/v1/companys/me/delete
module.exports.delete = async (req, res) => {
  try {
    // X√≥a t·∫•t c·∫£ CV thu·ªôc v·ªÅ c√¥ng ty
    await CV.deleteMany({ idCompany: req.company._id });

    // X√≥a t·∫•t c·∫£ Job thu·ªôc v·ªÅ c√¥ng ty
    await Job.deleteMany({ idCompany: req.company._id });

    // Cu·ªëi c√πng x√≥a c√¥ng ty
    await Company.findByIdAndDelete(req.company._id);

    res.clearCookie("token", {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
    });

    res.json({ code: 200, message: "X√≥a t√†i kho·∫£n th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[POST] api/v1/companys/me/change-password
module.exports.changePassword = async (req, res) => {
  try {
    const { oldPassword, newPassword } = req.body;
    const company = await Company.findOne({ _id: req.company._id });
    if (company.password !== md5(oldPassword)) {
      return res
        .status(400)
        .json({ code: 400, message: "M·∫≠t kh·∫©u c≈© kh√¥ng ch√≠nh x√°c" });
    }
    if (company.password === md5(newPassword)) {
      return res.status(400).json({
        code: 400,
        message: "M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c gi·ªëng m·∫≠t kh·∫©u c≈©",
      });
    }
    company.password = md5(newPassword);
    await company.save();
    res.status(200).json({ code: 200, message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[POST] api/v1/companys/password/forgot
module.exports.forgotPassword = async (req, res) => {
  try {
    const email = req.body.email;
    if (!email) {
      return res.status(400).json({ message: "Vui l√≤ng nh·∫≠p email" });
    }
    const user = await Company.findOne({ email: email });
    if (!user) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    const otpRandom = generateHelper.generateRandomNumber();
    const otbObject = {
      email: email,
      otp: otpRandom,
      type: "forgot",
      expiresAt: Date.now(),
    };
    const otp = new Otp(otbObject);
    await otp.save();
    const subject = "IT JOB - M√£ OTP x√°c minh t√†i kho·∫£n";
    sendMailHelper.sendMail(email, subject, otpRandom);
    res.json({ code: 200, message: "OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i qua gmail c·ªßa b·∫°n" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[POST] api/v1/companys/password/otp
module.exports.otpPassword = async (req, res) => {
 try {
   const { email, otp } = req.body;
  const otpCheck = await Otp.findOne({
    email: email,
    otp: otp,
    type: "forgot",
  });
  if (!otpCheck) {
    return res.status(400).json({ message: "Sai otp" });
  }
  const company = await Company.findOne({ email: email });
  if (!company) {
    return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
  }
  const tokenReset = generateHelper.generateToken();
  const objectResetToken = {
    email: email,
    expiresAt: Date.now(),
    resetToken: tokenReset,
  };
  const resetToken = new ResetToken(objectResetToken);
  await resetToken.save();
  await Otp.findOneAndDelete({ email: email }); // ƒê√∫ng c√∫ ph√°p
  res.status(200).json({
    code: 200,
    message: "X√°c minh th√†nh c√¥ng, vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u",
    resetToken: resetToken.resetToken,
  });
 } catch (error) {
   console.error(error);
   res.status(500).json({ message: "LoÃÇÃÉi server" });
  
 }
};

//[POST] api/v1/companys/password/resendOtp
module.exports.resendOtp = async (req, res) => {
  try {
    const { email } = req.body;
    const company = await Company.findOne({ email: email, deleted: false });
    if (!company) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    const otp = generateHelper.generateRandomNumber();
    await Otp.findOneAndDelete({ email: email, type: "forgot" });

    const otbObject = {
      email: email,
      otp: otp,
      type: "forgot",
      expiresAt: Date.now(),
    };
    const otpCheck = new Otp(otbObject);
    await otpCheck.save();
    const subject = "IT JOB - M√£ OTP x√°c minh t√†i kho·∫£n";
    sendMailHelper.sendMail(email, subject, otp);
    return res.status(200).json({ code: 200, message: "M√£ OTP m·ªõi ƒë∆∞·ª£c g·ª≠i" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
  }
};

//[POST] api/v1/companys/password/reset
module.exports.resetPassword = async (req, res) => {
  try {
    const { email, resetToken, newPassword } = req.body;
  const resetTokenCheck = await ResetToken.findOne({
    email: email,
    resetToken: resetToken,
  });
  if (!resetTokenCheck) {
    return res.status(400).json({
      message: "D·ªØ li·ªáu check reset password l·ªói, vui l√≤ng l√†m l·∫°i t·ª´ ƒë·∫ßu",
    });
  }
  const company = await Company.findOne({ email: email });
  if (!company) {
    return res.status(400).json({ message: "Email kh√¥ng t·ªìn t·∫°i" });
  }
  if (company.password === md5(newPassword)) {
    return res
      .status(400)
      .json({ message: "M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c gi·ªëng m·∫≠t kh·∫©u c≈©" });
  }
  company.password = md5(newPassword);
  await company.save();
  await ResetToken.findOneAndDelete({ email: email });
  res.cookie("token", company.token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production", // production th√¨ secure: true
    sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
    maxAge: 7 * 24 * 60 * 60 * 1000,
  });

  res.status(200).json({
    code: 200,
    message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng v√† ƒëƒÉng nh·∫≠p th√†nh c√¥ng",
  });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "LoÃÇÃÉi server" });
    
  }
};

```

### api\v1\controllers\cv.controller.js
```js
const Cv = require("../models/cv.model");
const sendMailHelper = require("../../../helpers/sendMail");

//[POST] /api/v1/cv/create
module.exports.create = async (req, res) => {
  try {
    const { selectedCvId, linkCV } = req.body;
    
    // Ki·ªÉm tra ƒë√£ g·ª≠i CV cho job n√†y ch∆∞a
    const existingCv = await Cv.findOne({
      email: req.body.email,
      phone: req.body.phone,
      idJob: req.body.idJob,
      deleted: false,
    });
    
    if (existingCv) {
      return res.status(400).json({ code: 400, message: "B·∫°n ƒë√£ g·ª≠i CV cho Job n√†y" });
    }

    // X·ª≠ l√Ω CV d·ª±a tr√™n lo·∫°i user
    if (selectedCvId) {
      // User ƒë√£ ƒëƒÉng k√Ω - ch·ªçn CV t·ª´ kho
      const UserCv = require("../models/user-cv.model");
      const selectedCV = await UserCv.findOne({
        _id: selectedCvId,
        idUser: req.body.idUser,
        deleted: false
      });
      
      if (!selectedCV) {
        return res.status(400).json({ 
          code: 400, 
          message: "CV kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng thu·ªôc v·ªÅ b·∫°n" 
        });
      }
      
      req.body.linkCV = selectedCV.cvUrl;
      req.body.selectedCvId = selectedCvId;
    } else if (linkCV) {
      // Kh√°ch v√£ng lai - upload CV m·ªõi
      req.body.linkCV = linkCV;
      req.body.idUser = null;
      req.body.selectedCvId = null;
    } else {
      return res.status(400).json({ 
        code: 400, 
        message: "Vui l√≤ng ch·ªçn CV t·ª´ danh s√°ch ho·∫∑c upload CV m·ªõi" 
      });
    }

    const newCv = await Cv.create(req.body);
    res.status(200).json({ 
      code: 200, 
      message: "G·ª≠i CV th√†nh c√¥ng", 
      cv: newCv 
    });
    
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[GET] /api/v1/cv
module.exports.index = async (req, res) => {
  try {
    const idCompany = req.company._id;
    const cvs = await Cv.find({ idCompany: idCompany, deleted: false });
    res.status(200).json(cvs);
  } catch (error) {
    res.status(500).json(error);
  }
};

//[DELETE] /api/v1/cv/delete/:id
module.exports.delete = async (req, res) => {
  try {
    const cv = await Cv.findOne({
      _id: req.params.id,
      idCompany: req.company._id,
      deleted: false,
    });
    if (cv) {
      await Cv.updateOne(
        { $and: [{ _id: req.params.id }, { idCompany: req.company._id }] },
        { deleted: true, deletedAt: new Date() }
      );
    }
    res.status(200).json({ code: 200, message: "ƒê√£ Xo√° CV" });
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};

//[GET] /api/v1/cv/detail/:id
module.exports.detail = async (req, res) => {
  try {
    const cv = await Cv.findOne({
      _id: req.params.id,
      idCompany: req.company._id,
      deleted: false,
    });
    res.status(200).json(cv);
  } catch (error) {
    res.status(500).json(error);
  }
};

//[PATCH] /api/v1/cv/change-status/:id
module.exports.changeStatus = async (req, res) => {
  try {
    const cv = await Cv.findByIdAndUpdate(
      { _id: req.params.id, idCompany: req.company._id, deleted: false },
      { status: 'read' }, // C·∫≠p nh·∫≠t t·ª´ statusRead th√†nh status v·ªõi gi√° tr·ªã 'read'
      { new: true }
    );
    res.status(200).json({ code: 200, message: "C·∫≠p nh·∫≠p ƒë√£ ƒë·ªçc", cv: cv });
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};

//[POST] /api/v1/cv/reply/:id
module.exports.reply = async (req, res) => {
  try {
    const { replyMessage } = req.body;
    
    if (!replyMessage) {
      return res.status(400).json({ 
        code: 400, 
        message: "Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi" 
      });
    }

    const cv = await Cv.findOne({
      _id: req.params.id,
      idCompany: req.company._id,
      deleted: false,
    });

    if (!cv) {
      return res.status(404).json({ 
        code: 404, 
        message: "Kh√¥ng t√¨m th·∫•y CV" 
      });
    }

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i CV th√†nh ƒë√£ ph·∫£n h·ªìi
    await Cv.findByIdAndUpdate(req.params.id, { 
      status: 'replied' 
    });

    // T·∫°o n·ªôi dung email ph·∫£n h·ªìi
    const subject = `IT JOB - Ph·∫£n h·ªìi t·ª´ ${req.company.companyName}`;
    const emailContent = `
      <div style="max-width: 600px; margin: auto; border: 1px solid #eee; padding: 30px; font-family: Arial, sans-serif; background-color: #f9f9f9;">
        <div style="text-align: center; padding-bottom: 20px;">
          <h1 style="color: #2e5aac; margin-bottom: 5px;">IT JOB</h1>
          <p style="margin: 0; color: #555;">N·ªÅn t·∫£ng k·∫øt n·ªëi vi·ªác l√†m ng√†nh CNTT</p>
        </div>
        
        <div style="background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
          <h2 style="color: #333;">Ph·∫£n h·ªìi t·ª´ nh√† tuy·ªÉn d·ª•ng</h2>
          <p style="font-size: 16px; color: #555;">Xin ch√†o <strong>${cv.name}</strong>,</p>
          
          <div style="background-color: #f8f9fa; padding: 20px; border-left: 4px solid #2e5aac; margin: 20px 0;">
            <p style="margin: 0;"><strong>C√¥ng ty:</strong> ${req.company.companyName}</p>
            <p style="margin: 10px 0 0 0;"><strong>Email li√™n h·ªá:</strong> ${req.company.email}</p>
            ${req.company.phone ? `<p style="margin: 10px 0 0 0;"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${req.company.phone}</p>` : ''}
          </div>
          
          <div style="background-color: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 6px; margin: 20px 0;">
            <h3 style="margin-top: 0; color: #2e5aac;">N·ªôi dung ph·∫£n h·ªìi:</h3>
            <p style="line-height: 1.6; color: #333; white-space: pre-line;">${replyMessage}</p>
          </div>
          
          <p style="color: #777; margin-top: 30px;">
            N·∫øu b·∫°n c√≥ b·∫•t k·ª≥ c√¢u h·ªèi n√†o, vui l√≤ng li√™n h·ªá tr·ª±c ti·∫øp v·ªõi c√¥ng ty qua th√¥ng tin b√™n tr√™n.
          </p>
          
          <p style="margin-top: 30px; color: #999;">
            Tr√¢n tr·ªçng,<br/>
            ƒê·ªôi ng≈© <strong>IT JOB</strong>
          </p>
        </div>
        
        <div style="text-align: center; font-size: 12px; color: #aaa; margin-top: 30px;">
          ¬© ${new Date().getFullYear()} IT JOB. All rights reserved.
        </div>
      </div>
    `;

    // G·ª≠i email ph·∫£n h·ªìi
    const nodemailer = require("nodemailer");
    const transporter = nodemailer.createTransporter({
      service: "gmail",
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASSWORD,
      },
    });

    const mailOptions = {
      from: process.env.EMAIL_USER,
      to: cv.email,
      subject: subject,
      html: emailContent,
    };

    transporter.sendMail(mailOptions, function (error, info) {
      if (error) {
        console.log("Error sending reply email:", error);
        return res.status(500).json({ 
          code: 500, 
          message: "L·ªói khi g·ª≠i email ph·∫£n h·ªìi" 
        });
      } else {
        console.log("Reply email sent: " + info.response);
        res.status(200).json({ 
          code: 200, 
          message: "Ph·∫£n h·ªìi ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng" 
        });
      }
    });

  } catch (error) {
    console.error(error);
    res.status(500).json("L·ªói server");
  }
};

//[GET] /api/v1/cv/my-cv-list (th√™m v√†o cv.controller.js)
module.exports.getMyCvList = async (req, res) => {
  try {
    const UserCv = require("../models/user-cv.model");
    const cvs = await UserCv.find({ 
      idUser: req.user._id, 
      deleted: false 
    }).select('_id cvName createdAt cvUrl').sort({ createdAt: -1 });
    
    res.status(200).json({
      code: 200,
      message: "L·∫•y danh s√°ch CV th√†nh c√¥ng",
      cvs: cvs
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};
```

### api\v1\controllers\job.controller.js
```js
const Job = require("../models/job.model");

//[GET] /api/v1/jobs
module.exports.index = async (req, res) => {
    try {
        const find = {
            deleted: false, 
            status: true
        }
       const jobs = await Job.find(find);
        
        res.status(200).json(jobs);
    } catch (error) {
        res.status(500).json(error);
    }
};

//[GET] /api/v1/jobs/info/:id
module.exports.info = async (req, res) => {
    try {
        const job = await Job.findOne({ _id: req.params.id, deleted: false });
        res.status(200).json(job);
    } catch (error) {
        res.status(500).json(error);
    }
};

//[GET] /api/v1/jobs/jobs-to-company
module.exports.jobToCompany = async (req, res) => {
    try {
        if(!req.params.id) {
            return res.status(200).json([]);
        }
        const jobs = await Job.find({ idCompany: req.params.id, deleted: false });
        res.status(200).json(jobs);
    } catch (error) {
        res.status(500).json(error);
    }
};

//[GET] /api/v1/jobs/me
module.exports.jobByCompany = async (req, res) => {
    try {
        const jobs = await Job.find({ idCompany: req.company._id, deleted: false });
        if(jobs.length > 0) {
            res.status(200).json(jobs);
        } else {
            res.status(200).json([]);
        }
    } catch (error) {
        res.status(500).json("LoÃÇÃÉi server");
    }
};

//[POST] /api/v1/jobs/create
module.exports.create = async (req, res) => {
    try {
        req.body.idCompany = req.company._id;
        const job = await Job.create(req.body);
        res.status(200).json(job);
    } catch (error) {
        res.status(500).json(error);
    }
};

//[PATCH] /api/v1/jobs/edit/:id
module.exports.edit = async (req, res) => {
    try {
        const jobCheck = await Job.findOne({ _id: req.params.id, idCompany: req.company._id, deleted: false });
        if(!jobCheck) {
            return res.status(200).json({ code: 404, message: "Kh√¥ng t√¨m th·∫•y job" });
        }
        const job = await Job.findByIdAndUpdate(req.params.id, req.body, { new: true });
        res.status(200).json({ code: 200, message: "CaÃ£ÃÇp nhaÃ£ÃÇt thaÃÄnh coÃÇng", job: job });
    } catch (error) {
        res.status(500).json("LoÃÇÃÉi server");
    }
};

//[DELETE] /api/v1/jobs/delete/:id
module.exports.delete = async (req, res) => {
    try {
        const jobCheck = await Job.findOne({ _id: req.params.id, idCompany: req.company._id, deleted: false });
        if(!jobCheck) {
            return res.status(200).json({ code: 404, message: "Kh√¥ng t√¨m th·∫•y job" });
        }
        await Job.findByIdAndUpdate(req.params.id, { deleted: true, deletedAt: new Date() });
        res.status(200).json({ code: 200, message: "Xo√° job th√†nh c√¥ng" });
    } catch (error) {
        res.status(500).json("LoÃÇÃÉi server");
    }
};
```

### api\v1\controllers\tag.controller.js
```js
const Tag = require("../models/tag.model");
//[GET] /api/v1/tags
module.exports.index = async (req, res) => {
    try {
        const tags = await Tag.find({});
        res.status(200).json(tags);
    } catch (error) {
        res.status(500).json("L·ªói server");
        console.log('error', error);
    }
};
```

### api\v1\controllers\user.controller.js
```js
const User = require("../models/user.model");
const UserCv = require("../models/user-cv.model");
const Cv = require("../models/cv.model");
const Otp = require("../models/otp.model");
const ResetToken = require("../models/reset-token.model");
const md5 = require("md5");
const sendMailHelper = require("../../../helpers/sendMail");
const generateHelper = require("../../../helpers/generate");

//[POST] /api/v1/users/auth/register
module.exports.register = async (req, res) => {
  try {
    const { phone, email, password, fullName } = req.body;
    
    const checkUser = await User.findOne({
      $or: [{ phone }, { email }],
    });
    
    if (checkUser?.email === email) {
      return res.status(400).json({ message: "Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng" });
    }
    if (checkUser?.phone === phone) {
      return res.status(400).json({ message: "S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng" });
    }

    req.body.password = md5(password);
    req.body.deleted = true;
    const user = new User(req.body);
    await user.save();

    const otpRandom = generateHelper.generateRandomNumber();
    const otpObject = {
      email: email,
      otp: otpRandom,
      type: "register",
      expiresAt: Date.now(),
    };
    const otp = new Otp(otpObject);
    await otp.save();
    
    const subject = "IT JOB - M√£ OTP x√°c minh t√†i kho·∫£n";
    sendMailHelper.sendMail(email, subject, otpRandom);
    
    res.json({
      code: 200,
      message: "ƒêƒÉng k√Ω th√†nh c√¥ng, vui l√≤ng x√°c minh t√†i kho·∫£n",
      email: email,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[POST] /api/v1/users/auth/register/checkEmailOtp
module.exports.checkEmailOtp = async (req, res) => {
  try {
    const { email, otp } = req.body;
    if (!otp) {
      return res.status(400).json({ message: "Vui l√≤ng nh·∫≠p otp" });
    }
    
    const otpCheck = await Otp.findOne({
      email: email,
      otp: otp,
      type: "register",
    });
    if (!otpCheck) {
      return res.status(400).json({ message: "Kh√¥ng t√¨m th·∫•y otp" });
    }
    
    const user = await User.findOne({ email: email });
    if (!user) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    
    const token = generateHelper.generateToken();
    user.token = token;
    user.deleted = false;
    await user.save();
    await Otp.findOneAndDelete({ email: email });
    
    res.cookie("userToken", token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    res.status(200).json({ code: 200, message: "X√°c minh th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};



//[POST] /api/v1/users/auth/login
module.exports.login = async (req, res) => {
  try {
    const user = await User.findOne({
      email: req.body.email,
      deleted: false,
    });
    if (!user) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    if (user.password !== md5(req.body.password)) {
      return res.status(400).json({ message: "Sai m·∫≠t kh·∫©u" });
    }
    
    const token = user.token;
    res.cookie("userToken", token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    res.json({ code: 200, message: "Login th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[GET] /api/v1/users/auth/logout
module.exports.logout = async (req, res) => {
  try {
    res.clearCookie("userToken", {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
    });
    res.json({ code: 200, message: "Logout th√†nh c√¥ng" });
  } catch (error) {
    res.status(500).json(error);
  }
};

//[GET] /api/v1/users/me
module.exports.detail = async (req, res) => {
  try {
    res.json({
      code: 200,
      message: "Th√†nh c√¥ng",
      user: req.user,
    });
  } catch (error) {
    res.status(500).json(error);
  }
};

//[PATCH] /api/v1/users/me/edit
module.exports.edit = async (req, res) => {
  try {
    const user = await User.findOneAndUpdate(
      { _id: req.user._id },
      req.body,
      { new: true }
    );
    res.json({ code: 200, message: "C·∫≠p nh·∫≠t th√†nh c√¥ng", user: user });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[DELETE] /api/v1/users/me/delete
module.exports.delete = async (req, res) => {
  try {
    await UserCv.deleteMany({ idUser: req.user._id });
    await Cv.deleteMany({ idUser: req.user._id });
    await User.findByIdAndDelete(req.user._id);

    res.clearCookie("userToken", {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
    });

    res.json({ code: 200, message: "X√≥a t√†i kho·∫£n th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[POST] /api/v1/users/me/change-password
module.exports.changePassword = async (req, res) => {
  try {
    const { oldPassword, newPassword } = req.body;
    const user = await User.findOne({ _id: req.user._id });
    
    if (user.password !== md5(oldPassword)) {
      return res
        .status(400)
        .json({ code: 400, message: "M·∫≠t kh·∫©u c≈© kh√¥ng ch√≠nh x√°c" });
    }
    if (user.password === md5(newPassword)) {
      return res.status(400).json({
        code: 400,
        message: "M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c gi·ªëng m·∫≠t kh·∫©u c≈©",
      });
    }
    
    user.password = md5(newPassword);
    await user.save();
    res.status(200).json({ code: 200, message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[POST] /api/v1/users/password/forgot
module.exports.forgotPassword = async (req, res) => {
  try {
    const email = req.body.email;
    if (!email) {
      return res.status(400).json({ message: "Vui l√≤ng nh·∫≠p email" });
    }
    
    const user = await User.findOne({ email: email });
    if (!user) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    
    const otpRandom = generateHelper.generateRandomNumber();
    const otpObject = {
      email: email,
      otp: otpRandom,
      type: "forgot",
      expiresAt: Date.now(),
    };
    const otp = new Otp(otpObject);
    await otp.save();
    
    const subject = "IT JOB - M√£ OTP x√°c minh t√†i kho·∫£n";
    sendMailHelper.sendMail(email, subject, otpRandom);
    res.json({ code: 200, message: "OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i qua gmail c·ªßa b·∫°n" });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[POST] /api/v1/users/password/otp
module.exports.otpPassword = async (req, res) => {
  try {
    const { email, otp } = req.body;
    const otpCheck = await Otp.findOne({
      email: email,
      otp: otp,
      type: "forgot",
    });
    if (!otpCheck) {
      return res.status(400).json({ message: "Sai otp" });
    }
    
    const user = await User.findOne({ email: email });
    if (!user) {
      return res.status(400).json({ message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i" });
    }
    
    const tokenReset = generateHelper.generateToken();
    const objectResetToken = {
      email: email,
      expiresAt: Date.now(),
      resetToken: tokenReset,
    };
    const resetToken = new ResetToken(objectResetToken);
    await resetToken.save();
    await Otp.findOneAndDelete({ email: email });
    
    res.status(200).json({
      code: 200,
      message: "X√°c minh th√†nh c√¥ng, vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u",
      resetToken: resetToken.resetToken,
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[POST] /api/v1/users/password/reset
module.exports.resetPassword = async (req, res) => {
  try {
    const { email, resetToken, newPassword } = req.body;
    const resetTokenCheck = await ResetToken.findOne({
      email: email,
      resetToken: resetToken,
    });
    if (!resetTokenCheck) {
      return res.status(400).json({
        message: "D·ªØ li·ªáu check reset password l·ªói, vui l√≤ng l√†m l·∫°i t·ª´ ƒë·∫ßu",
      });
    }
    
    const user = await User.findOne({ email: email });
    if (!user) {
      return res.status(400).json({ message: "Email kh√¥ng t·ªìn t·∫°i" });
    }
    if (user.password === md5(newPassword)) {
      return res
        .status(400)
        .json({ message: "M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c gi·ªëng m·∫≠t kh·∫©u c≈©" });
    }
    
    user.password = md5(newPassword);
    await user.save();
    await ResetToken.findOneAndDelete({ email: email });
    
    res.cookie("userToken", user.token, {
      httpOnly: true,
      secure: process.env.NODE_ENV === "production",
      sameSite: process.env.NODE_ENV === "production" ? "none" : "lax",
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    res.status(200).json({
      code: 200,
      message: "ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng v√† ƒëƒÉng nh·∫≠p th√†nh c√¥ng",
    });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

//[GET] /api/v1/users/my-cvs
module.exports.getMyCvs = async (req, res) => {
  try {
    const cvs = await UserCv.find({ 
      idUser: req.user._id, 
      deleted: false 
    }).sort({ createdAt: -1 });
    
    res.status(200).json(cvs);
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};

//[POST] /api/v1/users/my-cvs/create
module.exports.createMyCv = async (req, res) => {
  try {
    req.body.idUser = req.user._id;
    const cv = await UserCv.create(req.body);
    res.status(200).json({ code: 200, message: "T·∫°o CV th√†nh c√¥ng", cv: cv });
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};

//[PATCH] /api/v1/users/my-cvs/edit/:id
module.exports.editMyCv = async (req, res) => {
  try {
    const cv = await UserCv.findOne({
      _id: req.params.id,
      idUser: req.user._id,
      deleted: false,
    });
    
    if (!cv) {
      return res.status(404).json({ message: "Kh√¥ng t√¨m th·∫•y CV" });
    }
    
    const updatedCv = await UserCv.findByIdAndUpdate(
      req.params.id,
      req.body,
      { new: true }
    );
    
    res.status(200).json({ 
      code: 200, 
      message: "C·∫≠p nh·∫≠t CV th√†nh c√¥ng", 
      cv: updatedCv 
    });
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};

//[DELETE] /api/v1/users/my-cvs/delete/:id
module.exports.deleteMyCv = async (req, res) => {
  try {
    const cv = await UserCv.findOne({
      _id: req.params.id,
      idUser: req.user._id,
      deleted: false,
    });
    
    if (!cv) {
      return res.status(404).json({ message: "Kh√¥ng t√¨m th·∫•y CV" });
    }
    
    await UserCv.findByIdAndUpdate(req.params.id, {
      deleted: true,
      deletedAt: new Date(),
    });
    
    res.status(200).json({ code: 200, message: "X√≥a CV th√†nh c√¥ng" });
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};

//[GET] /api/v1/users/sent-cvs
module.exports.getSentCvs = async (req, res) => {
  try {
    const cvs = await Cv.find({ 
      idUser: req.user._id, 
      deleted: false 
    }).sort({ createdAt: -1 });
    
    res.status(200).json(cvs);
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};

//[DELETE] /api/v1/users/sent-cvs/withdraw/:id
module.exports.withdrawCv = async (req, res) => {
  try {
    const cv = await Cv.findOne({
      _id: req.params.id,
      idUser: req.user._id,
      deleted: false,
    });
    
    if (!cv) {
      return res.status(404).json({ message: "Kh√¥ng t√¨m th·∫•y CV ƒë√£ g·ª≠i" });
    }
    
    // Ch·ªâ cho ph√©p thu h·ªìi CV n·∫øu ch∆∞a ƒë∆∞·ª£c ƒë·ªçc
    if (cv.status !== 'unread') {
      return res.status(400).json({ 
        message: "Kh√¥ng th·ªÉ thu h·ªìi CV ƒë√£ ƒë∆∞·ª£c xem ho·∫∑c ph·∫£n h·ªìi" 
      });
    }
    
    await Cv.findByIdAndUpdate(req.params.id, {
      deleted: true,
      deletedAt: new Date(),
    });
    
    res.status(200).json({ code: 200, message: "Thu h·ªìi CV th√†nh c√¥ng" });
  } catch (error) {
    res.status(500).json("L·ªói server");
  }
};
```

### api\v1\middlewares\auth.middleware.js
```js
const Company = require("../models/company.model");
module.exports.requireAuth = async (req, res, next) => {
    try {
            const token = req.cookies.token;
    if(!token) {
        return res.status(401).json({Code: 400, message: "D·ªØ li·ªáu l·ªói, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i"});
    }
    const company = await Company.findOne({token: token, deleted: false}).select("-password -token");
    if (!company) {
        return res.status(401).json({Code: 400, message: "TaÃÄi khoaÃân khoÃÇng toÃÇÃÄn taÃ£i"});
    }
    req.company = company;
    next();
    } catch (error) {
        console.error(error);
        res.status(500).json({message: "LoÃÇÃÉi server"});
        
    }
}


```

### api\v1\middlewares\optional-auth.middleware.js
```js
const User = require("../models/user.model");

// Middleware t√πy ch·ªçn - kh√¥ng b·∫Øt bu·ªôc ph·∫£i ƒëƒÉng nh·∫≠p
module.exports.optionalAuth = async (req, res, next) => {
    try {
        const token = req.cookies.userToken;
        
        if (token) {
            const user = await User.findOne({
                token: token, 
                deleted: false
            }).select("-password -token");
            
            if (user) {
                req.user = user;
                req.body.idUser = user._id.toString();
            }
        }
        
        // N·∫øu kh√¥ng c√≥ token ho·∫∑c user kh√¥ng t·ªìn t·∫°i, v·∫´n cho ph√©p ti·∫øp t·ª•c
        next();
    } catch (error) {
        console.error(error);
        // N·∫øu c√≥ l·ªói, v·∫´n cho ph√©p ti·∫øp t·ª•c nh∆∞ kh√°ch v√£ng lai
        next();
    }
}
```

### api\v1\middlewares\user-auth.middleware.js
```js
const User = require("../models/user.model");

module.exports.requireAuth = async (req, res, next) => {
    try {
        const token = req.cookies.userToken;
        if(!token) {
            return res.status(401).json({code: 400, message: "D·ªØ li·ªáu l·ªói, vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i"});
        }
        
        const user = await User.findOne({token: token, deleted: false}).select("-password -token");
        if (!user) {
            return res.status(401).json({code: 400, message: "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i"});
        }
        
        req.user = user;
        next();
    } catch (error) {
        console.error(error);
        res.status(500).json({message: "L·ªói server"});
    }
}
```

### api\v1\models\city.model.js
```js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const citySchema = new Schema({
    value: String,
    key: Number
    });
const City = mongoose.model('City', citySchema, 'citys');
module.exports =  City;
```

### api\v1\models\company.model.js
```js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const companySchema = new Schema({
    companyName: String,
    description: String,
    phone: String,
    email: String,
    address: String,
    password: String,
    token: String,
    quantityPeople: Number,
    detail: String,
    workingTime: String,
    website: String,
    deleted: {
        type: Boolean,
        default: false
    },
    deletedAt: Date
}, {
    // D√πng ƒë·ªÉ th√™m th·ªùi gian t·∫°o v√† c·∫≠p nh·∫≠t s·∫£n ph·∫©m t·ª± ƒë·ªông
    timestamps: true
});
const Company = mongoose.model('Company', companySchema, 'companys');
module.exports =  Company;
```

### api\v1\models\cv.model.js
```js
const mongoose = require("mongoose");
const Schema = mongoose.Schema;

const cvSchema = new Schema({
    name: String,
    phone: String,
    email: String,
    city: String,
    description: String,
    status: {
        type: String,
        enum: ['unread', 'read', 'replied'], // unread: ch∆∞a ƒë·ªçc, read: ƒë√£ ƒë·ªçc, replied: ƒë√£ ph·∫£n h·ªìi
        default: 'unread'
    },
    linkProject: String,
    linkCV: String, // URL c·ªßa CV ƒë∆∞·ª£c g·ª≠i
    selectedCvId: String, // ID c·ªßa CV t·ª´ user_cvs collection (n·∫øu user ƒë√£ ƒëƒÉng k√Ω)
    idCompany: String,
    idJob: String,
    idUser: String, // ID c·ªßa user (null n·∫øu l√† kh√°ch v√£ng lai)
    deleted: {
        type: Boolean,
        default: false
    },
    deletedAt: Date
}, {
    timestamps: true
});

const Cv = mongoose.model('Cv', cvSchema, 'cv');
module.exports = Cv;
```

### api\v1\models\job.model.js
```js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const JobSchema = new Schema({
    name: String,
    description: String,
    status: Boolean,
    idCompany: String,
    tags: Array,
    salary: String,
    city: Array,
    deleted: {
        type: Boolean,
        default: false
    },
    deletedAt: Date
}, {
    // D√πng ƒë·ªÉ th√™m th·ªùi gian t·∫°o v√† c·∫≠p nh·∫≠t s·∫£n ph·∫©m t·ª± ƒë·ªông
    timestamps: true
});
const Job = mongoose.model('Job', JobSchema, 'jobs');
module.exports =  Job;


```

### api\v1\models\otp.model.js
```js
const mongoose = require("mongoose");
const Schema = mongoose.Schema;

const otpSchema = new Schema(
  {
    email: String,
    otp: String,
    type: String,
    expiresAt: {
      type: Date,
      expires: 300,
    },
  },
  {
    // D√πng ƒë·ªÉ th√™m th·ªùi gian t·∫°o v√† c·∫≠p nh·∫≠t s·∫£n ph·∫©m t·ª± ƒë·ªông
    timestamps: true,
  }
);
const Otp = mongoose.model("Otp", otpSchema, "otps");
module.exports = Otp;

```

### api\v1\models\reset-token.model.js
```js
const mongoose = require("mongoose");
const Schema = mongoose.Schema;

const resetTokenSchema = new Schema(
    {
        email: String,
        resetToken: String,
        expiresAt: {
            type: Date,
            expires: 300,
        },
    },
    {
        // D√πng ƒë·ªÉ th√™m th·ªùi gian t·∫°o v√† c·∫≠p nh·∫≠t s·∫£n ph·∫©m t·ª± ƒë·ªông
        timestamps: true,
    }
);
const ResetToken = mongoose.model("ResetToken", resetTokenSchema, "reset-tokens");
module.exports = ResetToken;
```

### api\v1\models\tag.model.js
```js
const mongoose = require("mongoose");
const Schema = mongoose.Schema;

const tagSchema = new Schema({
    value: String,
    key: Number,
    deleted: {
        type: Boolean,
        default: false
    },
    deletedAt: Date
}, {
    // D√πng ƒë·ªÉ th√™m th·ªùi gian t·∫°o v√† c·∫≠p nh·∫≠t s·∫£n ph·∫©m t·ª± ƒë·ªông
    timestamps: true
});
const Tag = mongoose.model('Tag', tagSchema, 'tags');
module.exports =  Tag;
```

### api\v1\models\user-cv.model.js
```js
const mongoose = require("mongoose");
const Schema = mongoose.Schema;

const userCvSchema = new Schema({
    cvName: String,
    cvUrl: String,
    idUser: String,
    deleted: {
        type: Boolean,
        default: false
    },
    deletedAt: Date
}, {
    timestamps: true
});

const UserCv = mongoose.model('UserCv', userCvSchema, 'user_cvs');
module.exports = UserCv;
```

### api\v1\models\user.model.js
```js
const mongoose = require('mongoose');
const Schema = mongoose.Schema;

const userSchema = new Schema({
    fullName: String,
    phone: String,
    email: String,
    password: String,
    token: String,
    city: String,
    address: String,
    dateOfBirth: Date,
    avatar: String,
    description: String,
    linkProject: String, // New field added
    deleted: {
        type: Boolean,
        default: false
    },
    deletedAt: Date
}, {
    timestamps: true
});

const User = mongoose.model('User', userSchema, 'users');
module.exports = User;
```

### api\v1\routes\city.route.js
```js
const  express  = require("express");
const router = express.Router();
const cityController = require("../controllers/city.controller");

router.get("/", cityController.index); 

module.exports = router;
```

### api\v1\routes\company.route.js
```js
const express = require("express");
const router = express.Router();
const companyController = require("../controllers/company.controller");
const authMiddlewares = require("../middlewares/auth.middleware");
const companyValidator = require("../validators/company.validator");


// middlewares/otpLimiter.js
const rateLimit = require("express-rate-limit");
//set th·ªùi gian gi√£n c√°ch g·ª≠i request
const otpLimiterByEmail = rateLimit({
  windowMs: 60 * 1000, // 60 gi√¢y
  max: 1,              // T·ªëi ƒëa 1 request trong 60 gi√¢y
  keyGenerator: (req) => req.body.email || req.ip, // ∆Øu ti√™n gi·ªõi h·∫°n theo email
  message: {
    code: 429,
    message: "B·∫°n ch·ªâ ƒë∆∞·ª£c y√™u c·∫ßu OTP m·ªói 60 gi√¢y.",
  },
  skipFailedRequests: true, // Kh√¥ng t√≠nh nh·ªØng request b·ªã l·ªói tr∆∞·ªõc ƒë√≥ (VD: nh·∫≠p sai ƒë·ªãnh d·∫°ng)
});



router.get("/", companyController.index); 
router.get("/info/:id", companyController.info); 

router.post("/auth/login", companyValidator.checkLogin, companyController.login);
router.post("/auth/register", companyValidator.checkRegister, companyController.register);
router.post("/auth/register/checkEmailOtp", companyController.checkEmailOtp);
router.post("/auth/register/resendCheckEmailOtp", otpLimiterByEmail, companyController.resendCheckEmailOtp);
router.post("/auth/logout", companyController.logout);
router.post("/auth/register/cancel-register", companyController.cancelRegister);

router.get("/me", authMiddlewares.requireAuth, companyController.detail);
router.delete("/me/delete", authMiddlewares.requireAuth, companyController.delete);
router.patch("/me/edit", authMiddlewares.requireAuth, companyValidator.checkEditCompany, companyController.edit);
router.patch("/me/change-password", authMiddlewares.requireAuth, companyValidator.checkChangePassword, companyController.changePassword);

router.post("/password/forgot", companyValidator.checkEmailResetPassword, otpLimiterByEmail, companyController.forgotPassword);
router.post("/password/otp", companyController.otpPassword);
router.post("/password/resendOtp", companyValidator.checkEmailResetPassword, otpLimiterByEmail, companyController.resendOtp);
router.post("/password/reset", companyValidator.checkResetPassword, companyController.resetPassword);

module.exports = router;
```

### api\v1\routes\cv.route.js
```js
const express = require("express");
const router = express.Router();
const cvController = require("../controllers/cv.controller");
const authMiddlewares = require("../middlewares/auth.middleware");
const userAuthMiddleware = require("../middlewares/user-auth.middleware");
const optionalAuthMiddleware = require("../middlewares/optional-auth.middleware");
const cvValidator = require("../validators/cv.validator");

// Public routes - c√≥ th·ªÉ l√† user ƒë√£ ƒëƒÉng k√Ω ho·∫∑c kh√°ch v√£ng lai
router.post("/create", optionalAuthMiddleware.optionalAuth, cvValidator.checkCreateCV, cvController.create);

// Company routes  
router.get("/", authMiddlewares.requireAuth, cvController.index); 
router.delete("/delete/:id", authMiddlewares.requireAuth, cvController.delete);
router.get("/detail/:id", authMiddlewares.requireAuth, cvController.detail);
router.patch("/change-status/:id", authMiddlewares.requireAuth, cvController.changeStatus);
router.post("/reply/:id", authMiddlewares.requireAuth, cvController.reply);

// User routes - ƒë·ªÉ l·∫•y danh s√°ch CV cho dropdown
router.get("/my-cv-list", userAuthMiddleware.requireAuth, cvController.getMyCvList);

module.exports = router;
```

### api\v1\routes\index.route.js
```js
const jobRoutes = require("./job.route");
const cityRoutes = require("./city.route");
const companyRoutes = require("./company.route");
const tagRoutes = require("./tag.route");
const cvRoutes = require("./cv.route");
const userRoutes = require("./user.route");

module.exports = (app) => {
    const version = "/api/v1";
    
    app.use(version + "/jobs", jobRoutes);
    app.use(version + "/city", cityRoutes);
    app.use(version + "/companys", companyRoutes);
    app.use(version + "/tags", tagRoutes);
    app.use(version + "/cv", cvRoutes);
    app.use(version + "/users", userRoutes);
}
```

### api\v1\routes\job.route.js
```js
const express = require("express");
const router = express.Router();
const jobController = require("../controllers/job.controller");
const jobValidator = require("../validators/job.validator");
const authMiddlewares = require("../middlewares/auth.middleware");
// [PUBLIC]
router.get("/", jobController.index); 
router.get("/info/:id", jobController.info); 
router.get("/jobs-to-company/:id", jobController.jobToCompany);

// [PRIVATE]
router.get("/me", authMiddlewares.requireAuth, jobController.jobByCompany);
router.post("/create", authMiddlewares.requireAuth, jobValidator.checkJob, jobController.create);
router.patch("/edit/:id", authMiddlewares.requireAuth, jobValidator.checkJob, jobController.edit);
router.delete("/delete/:id", authMiddlewares.requireAuth, jobController.delete);
module.exports = router;

```

### api\v1\routes\tag.route.js
```js
const express = require("express");
const router = express.Router();
const tagController = require("../controllers/tag.controller");

router.get("/", tagController.index); 

module.exports = router;
```

### api\v1\routes\user.route.js
```js
const express = require("express");
const router = express.Router();
const userController = require("../controllers/user.controller");
const userAuthMiddleware = require("../middlewares/user-auth.middleware");
const userValidator = require("../validators/user.validator");

// Rate limiter for OTP requests
const rateLimit = require("express-rate-limit");
const otpLimiterByEmail = rateLimit({
  windowMs: 60 * 1000, // 60 gi√¢y
  max: 1,              // T·ªëi ƒëa 1 request trong 60 gi√¢y
  keyGenerator: (req) => req.body.email || req.ip,
  message: {
    code: 429,
    message: "B·∫°n ch·ªâ ƒë∆∞·ª£c y√™u c·∫ßu OTP m·ªõi 60 gi√¢y.",
  },
  skipFailedRequests: true,
});

// Authentication routes
router.post("/auth/register", userValidator.checkRegister, userController.register);
router.post("/auth/register/checkEmailOtp", userController.checkEmailOtp);
router.post("/auth/register/resendCheckEmailOtp", otpLimiterByEmail, userController.resendCheckEmailOtp);
router.post("/auth/login", userValidator.checkLogin, userController.login);
router.post("/auth/logout", userController.logout);
router.post("/auth/register/cancel-register", userController.cancelRegister);

// Profile management routes
router.get("/me", userAuthMiddleware.requireAuth, userController.detail);
router.patch("/me/edit", userAuthMiddleware.requireAuth, userValidator.checkEditUser, userController.edit);
router.delete("/me/delete", userAuthMiddleware.requireAuth, userController.delete);
router.patch("/me/change-password", userAuthMiddleware.requireAuth, userValidator.checkChangePassword, userController.changePassword);

// Password reset routes
router.post("/password/forgot", userValidator.checkEmailResetPassword, otpLimiterByEmail, userController.forgotPassword);
router.post("/password/otp", userController.otpPassword);
router.post("/password/resendOtp", userValidator.checkEmailResetPassword, otpLimiterByEmail, userController.resendOtp);
router.post("/password/reset", userValidator.checkResetPassword, userController.resetPassword);

// My CVs management routes
router.get("/my-cvs", userAuthMiddleware.requireAuth, userController.getMyCvs);
router.post("/my-cvs/create", userAuthMiddleware.requireAuth, userValidator.checkMyCv, userController.createMyCv);
router.patch("/my-cvs/edit/:id", userAuthMiddleware.requireAuth, userValidator.checkMyCv, userController.editMyCv);
router.delete("/my-cvs/delete/:id", userAuthMiddleware.requireAuth, userController.deleteMyCv);

// Sent CVs management routes
router.get("/sent-cvs", userAuthMiddleware.requireAuth, userController.getSentCvs);
router.delete("/sent-cvs/withdraw/:id", userAuthMiddleware.requireAuth, userController.withdrawCv);

module.exports = router;
```

### api\v1\validators\company.validator.js
```js
// H√†m ki·ªÉm tra ƒë·ªô m·∫°nh c·ªßa m·∫≠t kh·∫©u
const isStrongPassword = (password) => {
  const specialCharRegex = /[!@#$%^&*(),.?":{}|<>]/;
  const upperCaseRegex = /[A-Z]/;
  const lowerCaseRegex = /[a-z]/;
  const numberRegex = /[0-9]/;

  if (password.length < 8) {
    return "M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±";
  }

  if (password.length > 20) {
    return "M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 20 k√Ω t·ª±";
  }

  if (/\s/.test(password)) {
    return "M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ch·ª©a k√Ω t·ª± tr·ªëng (space)";
  }

  if (!upperCaseRegex.test(password)) {
    return "M·∫≠t kh·∫©u ph·∫£i ch·ª©a √≠t nh·∫•t m·ªôt ch·ªØ c√°i vi·∫øt hoa";
  }

  if (!lowerCaseRegex.test(password)) {
    return "M·∫≠t kh·∫©u ph·∫£i ch·ª©a √≠t nh·∫•t m·ªôt ch·ªØ c√°i vi·∫øt th∆∞·ªùng";
  }

  if (!numberRegex.test(password)) {
    return "M·∫≠t kh·∫©u ph·∫£i ch·ª©a √≠t nh·∫•t m·ªôt s·ªë";
  }

  if (!specialCharRegex.test(password[password.length - 1])) {
    return "K√Ω t·ª± cu·ªëi c·ªßa m·∫≠t kh·∫©u ph·∫£i l√† k√Ω t·ª± ƒë·∫∑c bi·ªát";
  }

  if (password[0] !== password[0].toUpperCase()) {
    return "K√Ω t·ª± ƒë·∫ßu ti√™n c·ªßa m·∫≠t kh·∫©u ph·∫£i vi·∫øt hoa";
  }

  return null; // h·ª£p l·ªá
};

// H√†m ki·ªÉm tra ƒë·ªô d√†i chu·ªói
const checkLength = (field, value, min, max) => {
  if (!value) return null;

  if (value.length < min) {
    return `${field} ph·∫£i c√≥ √≠t nh·∫•t ${min} k√Ω t·ª±`;
  }

  if (value.length > max) {
    return `${field} kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° ${max} k√Ω t·ª±`;
  }

  return null;
};

// ki·ªÉm tra ƒëƒÉng nh·∫≠p
const checkLogin = (req, res, next) => {
  const { email, password } = req.body;

  if (!email) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a nh·∫≠p email" });
  }

  if (!password) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u" });
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return res.status(400).json({ code: 400, message: "Email kh√¥ng h·ª£p l·ªá" });
  }

  const emailLengthError = checkLength("Email", email, 5, 100);
  if (emailLengthError) {
    return res.status(400).json({ code: 400, message: emailLengthError });
  }

  if (password.length < 8 || password.length > 20) {
    return res
      .status(400)
      .json({ code: 400, message: "ƒê·ªô d√†i m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá" });
  }

  next();
};

// ki·ªÉm tra ƒëƒÉng k√Ω
const checkRegister = (req, res, next) => {
  const { email, password, phone, companyName } = req.body;

  if (!email) {
    return res.status(400).json({ code: 400, message: "Vui l√≤ng nh·∫≠p email" });
  }
  if (!phone) {
    return res
      .status(400)
      .json({ code: 400, message: "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" });
  }
  if (!companyName) {
    return res
      .status(400)
      .json({ code: 400, message: "Vui l√≤ng nh·∫≠p t√™n c√¥ng ty" });
  }

  const emailLengthError = checkLength("Email", email, 5, 100);
  const phoneLengthError = checkLength("S·ªë ƒëi·ªán tho·∫°i", phone, 9, 11);
  const nameLengthError = checkLength("T√™n c√¥ng ty", companyName, 2, 100);

  const lengthError = emailLengthError || phoneLengthError || nameLengthError;
  if (lengthError) {
    return res.status(400).json({ code: 400, message: lengthError });
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return res.status(400).json({ code: 400, message: "Email kh√¥ng h·ª£p l·ªá" });
  }

  const phoneRegex = /^(0|\+84)[0-9]{9}$/;
  if (!phoneRegex.test(phone)) {
    return res
      .status(400)
      .json({ code: 400, message: "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá" });
  }

  const error = isStrongPassword(password);
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

// ki·ªÉm tra email qu√™n m·∫≠t kh·∫©u
const checkEmailResetPassword = (req, res, next) => {
  const { email } = req.body;

  if (!email) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a nh·∫≠p email" });
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return res.status(400).json({ code: 400, message: "Email kh√¥ng h·ª£p l·ªá" });
  }

  next();
};

// ki·ªÉm tra reset m·∫≠t kh·∫©u
const checkResetPassword = (req, res, next) => {
  try {
    const newPassword = req.body.newPassword;

    if (!newPassword) {
      return res
        .status(400)
        .json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u m·ªõi" });
    }

    const error = isStrongPassword(newPassword);
    if (error) {
      return res.status(400).json({ code: 400, message: error });
    }

    next();
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

// ki·ªÉm tra ƒë·ªïi m·∫≠t kh·∫©u
const checkChangePassword = (req, res, next) => {
  const { oldPassword, newPassword } = req.body;

  if (!oldPassword) {
    return res
      .status(400)
      .json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u c≈©" });
  }

  if (!newPassword) {
    return res
      .status(400)
      .json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u m·ªõi" });
  }

  if (oldPassword === newPassword) {
    return res.status(400).json({
      code: 400,
      message: "M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c gi·ªëng m·∫≠t kh·∫©u c≈©",
    });
  }

  const error = isStrongPassword(newPassword);
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

// ki·ªÉm tra ch·ªânh s·ª≠a c√¥ng ty
const checkEditCompany = (req, res, next) => {
  const {
    companyName,
    phone,
    email,
    address,
    description,
    quantityPeople,
    detail,
    workingTime,
    website,
  } = req.body;

  if (email !== req.company.email) {
    return res
      .status(400)
      .json({ code: 400, message: "Kh√¥ng ƒë∆∞·ª£c thay ƒë·ªïi email" });
  }

  if (!companyName || !phone || !address || !description) {
    return res
      .status(400)
      .json({ code: 400, message: "Ch∆∞a nh·∫≠p ƒë·ªß th√¥ng tin y√™u c·∫ßu" });
  }

  const validations = [
    checkLength("T√™n c√¥ng ty", companyName, 2, 100),
    checkLength("S·ªë ƒëi·ªán tho·∫°i", phone, 9, 11),
    checkLength("ƒê·ªãa ch·ªâ", address, 5, 200),
    checkLength("M√¥ t·∫£", description, 10, 1000),
  ];
  if (quantityPeople) {
    validations.push(checkLength("S·ªë ng∆∞·ªùi", quantityPeople, 1, 100));
  }
  if (detail) {
    validations.push(checkLength("Chi ti·∫øt", detail, 10, 1000));
  }
  if (workingTime) {
    validations.push(checkLength("Th·ªùi gian l√†m vi·ªác", workingTime, 1, 200));
  }
  if (website) {
    validations.push(checkLength("Website", website, 1, 200));
  }

  const error = validations.find((msg) => msg !== null);
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

// Export t·∫•t c·∫£ middleware
module.exports = {
  checkLogin,
  checkRegister,
  checkLength,
  checkEmailResetPassword,
  checkResetPassword,
  checkChangePassword,
  checkEditCompany,
  isStrongPassword, // Export this function for use in user.validator.js
};
```

### api\v1\validators\cv.validator.js
```js
const { checkLength } = require("./company.validator");

module.exports.checkCreateCV = (req, res, next) => {
  try {
    const { name, phone, email, city, description, linkProject, selectedCvId, linkCV, idUser } = req.body;

    // Ki·ªÉm tra thi·∫øu tr∆∞·ªùng c∆° b·∫£n
    if (!name || !phone || !email || !city || !description || !linkProject) {
      return res
        .status(400)
        .json({ code: 400, message: "Ch∆∞a nh·∫≠p ƒë·ªß th√¥ng tin c·∫ßn thi·∫øt" });
    }

    // Ki·ªÉm tra CV logic
    if (idUser) {
      // User ƒë√£ ƒëƒÉng k√Ω - ph·∫£i ch·ªçn CV t·ª´ dropdown
      if (!selectedCvId) {
        return res.status(400).json({ 
          code: 400, 
          message: "Vui l√≤ng ch·ªçn CV t·ª´ danh s√°ch c·ªßa b·∫°n" 
        });
      }
      if (linkCV) {
        return res.status(400).json({ 
          code: 400, 
          message: "User ƒë√£ ƒëƒÉng k√Ω kh√¥ng th·ªÉ upload CV tr·ª±c ti·∫øp" 
        });
      }
    } else {
      // Kh√°ch v√£ng lai - ph·∫£i upload CV m·ªõi
      if (!linkCV) {
        return res.status(400).json({ 
          code: 400, 
          message: "Vui l√≤ng upload CV" 
        });
      }
      if (selectedCvId) {
        return res.status(400).json({ 
          code: 400, 
          message: "Kh√°ch v√£ng lai kh√¥ng th·ªÉ ch·ªçn CV t·ª´ danh s√°ch" 
        });
      }
    }

    // Ki·ªÉm tra ƒë·ªô d√†i t·ª´ng tr∆∞·ªùng
    const validations = [
      checkLength("H·ªç v√† t√™n", name, 2, 100),
      checkLength("S·ªë ƒëi·ªán tho·∫°i", phone, 9, 11),
      checkLength("Email", email, 5, 100),
      checkLength("M√¥ t·∫£ b·∫£n th√¢n", description, 10, 2000),
      checkLength("Link d·ª± √°n", linkProject, 5, 500),
    ];

    if (linkCV) {
      validations.push(checkLength("Link CV", linkCV, 5, 500));
    }

    const error = validations.find((msg) => msg !== null);
    if (error) {
      return res.status(400).json({ code: 400, message: error });
    }

    // Regex ki·ªÉm tra ƒë·ªãnh d·∫°ng
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      return res.status(400).json({ code: 400, message: "Email kh√¥ng h·ª£p l·ªá" });
    }

    const phoneRegex = /^(0|\+84)[0-9]{9}$/;
    if (!phoneRegex.test(phone)) {
      return res
        .status(400)
        .json({ code: 400, message: "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá" });
    }

    next();
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};
```

### api\v1\validators\job.validator.js
```js
const { checkLength } = require("./company.validator");

const checkJob = (req, res, next) => {
  const { name, tags, salary, city, description } = req.body;

  // Ki·ªÉm tra thi·∫øu tr∆∞·ªùng
  if (!name || !tags || !salary || !city || !description) {
    return res.status(400).json({
      code: 400,
      message: "Ch∆∞a nh·∫≠p ƒë·ªß th√¥ng tin",
    });
  }

  // Ki·ªÉm tra ƒë·ªô d√†i n·ªôi dung
  const validations = [
    checkLength("T√™n c√¥ng vi·ªác", name, 3, 100),
    checkLength("M·ª©c l∆∞∆°ng", salary, 2, 100),
    checkLength("M√¥ t·∫£ c√¥ng vi·ªác", description, 10, 2000),
  ];

  const error = validations.find((msg) => msg !== null);
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

module.exports = { checkJob };

```

### api\v1\validators\user.validator.js
```js
const { isStrongPassword, checkLength } = require("./company.validator");

// Ki·ªÉm tra ƒëƒÉng nh·∫≠p user
const checkLogin = (req, res, next) => {
  const { email, password } = req.body;

  if (!email) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a nh·∫≠p email" });
  }

  if (!password) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u" });
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return res.status(400).json({ code: 400, message: "Email kh√¥ng h·ª£p l·ªá" });
  }

  const emailLengthError = checkLength("Email", email, 5, 100);
  if (emailLengthError) {
    return res.status(400).json({ code: 400, message: emailLengthError });
  }

  if (password.length < 8 || password.length > 20) {
    return res
      .status(400)
      .json({ code: 400, message: "ƒê·ªô d√†i m·∫≠t kh·∫©u kh√¥ng h·ª£p l·ªá" });
  }

  next();
};

// Ki·ªÉm tra ƒëƒÉng k√Ω user
const checkRegister = (req, res, next) => {
  const { email, password, phone, fullName } = req.body;

  if (!email) {
    return res.status(400).json({ code: 400, message: "Vui l√≤ng nh·∫≠p email" });
  }
  if (!phone) {
    return res
      .status(400)
      .json({ code: 400, message: "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" });
  }
  if (!fullName) {
    return res
      .status(400)
      .json({ code: 400, message: "Vui l√≤ng nh·∫≠p h·ªç v√† t√™n" });
  }

  const emailLengthError = checkLength("Email", email, 5, 100);
  const phoneLengthError = checkLength("S·ªë ƒëi·ªán tho·∫°i", phone, 9, 11);
  const nameLengthError = checkLength("H·ªç v√† t√™n", fullName, 2, 100);

  const lengthError = emailLengthError || phoneLengthError || nameLengthError;
  if (lengthError) {
    return res.status(400).json({ code: 400, message: lengthError });
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return res.status(400).json({ code: 400, message: "Email kh√¥ng h·ª£p l·ªá" });
  }

  const phoneRegex = /^(0|\+84)[0-9]{9}$/;
  if (!phoneRegex.test(phone)) {
    return res
      .status(400)
      .json({ code: 400, message: "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá" });
  }

  const error = isStrongPassword(password);
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

// Ki·ªÉm tra email reset password
const checkEmailResetPassword = (req, res, next) => {
  const { email } = req.body;

  if (!email) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a nh·∫≠p email" });
  }

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return res.status(400).json({ code: 400, message: "Email kh√¥ng h·ª£p l·ªá" });
  }

  next();
};

// Ki·ªÉm tra reset m·∫≠t kh·∫©u
const checkResetPassword = (req, res, next) => {
  try {
    const newPassword = req.body.newPassword;

    if (!newPassword) {
      return res
        .status(400)
        .json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u m·ªõi" });
    }

    const error = isStrongPassword(newPassword);
    if (error) {
      return res.status(400).json({ code: 400, message: error });
    }

    next();
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "L·ªói server" });
  }
};

// Ki·ªÉm tra ƒë·ªïi m·∫≠t kh·∫©u
const checkChangePassword = (req, res, next) => {
  const { oldPassword, newPassword } = req.body;

  if (!oldPassword) {
    return res
      .status(400)
      .json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u c≈©" });
  }

  if (!newPassword) {
    return res
      .status(400)
      .json({ code: 400, message: "Ch∆∞a nh·∫≠p m·∫≠t kh·∫©u m·ªõi" });
  }

  if (oldPassword === newPassword) {
    return res.status(400).json({
      code: 400,
      message: "M·∫≠t kh·∫©u m·ªõi kh√¥ng ƒë∆∞·ª£c gi·ªëng m·∫≠t kh·∫©u c≈©",
    });
  }

  const error = isStrongPassword(newPassword);
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

// Ki·ªÉm tra ch·ªânh s·ª≠a user - UPDATED to include linkProject validation
const checkEditUser = (req, res, next) => {
  const { fullName, phone, email, city, address, description, linkProject } = req.body;

  if (email !== req.user.email) {
    return res
      .status(400)
      .json({ code: 400, message: "Kh√¥ng ƒë∆∞·ª£c thay ƒë·ªïi email" });
  }

  if (!fullName || !phone) {
    return res
      .status(400)
      .json({ code: 400, message: "Ch∆∞a nh·∫≠p ƒë·ªß th√¥ng tin y√™u c·∫ßu" });
  }

  const validations = [
    checkLength("H·ªç v√† t√™n", fullName, 2, 100),
    checkLength("S·ªë ƒëi·ªán tho·∫°i", phone, 9, 11),
  ];

  if (city) {
    validations.push(checkLength("Th√†nh ph·ªë", city, 1, 100));
  }
  if (address) {
    validations.push(checkLength("ƒê·ªãa ch·ªâ", address, 5, 200));
  }
  if (description) {
    validations.push(checkLength("M√¥ t·∫£", description, 10, 1000));
  }
  // NEW: Add linkProject validation
  if (linkProject) {
    validations.push(checkLength("Link d·ª± √°n", linkProject, 5, 500));
  }

  const error = validations.find((msg) => msg !== null);
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

// Ki·ªÉm tra t·∫°o/s·ª≠a CV c√° nh√¢n
const checkMyCv = (req, res, next) => {
  const { cvName, cvUrl } = req.body;

  if (!cvName) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a nh·∫≠p t√™n CV" });
  }

  if (!cvUrl) {
    return res.status(400).json({ code: 400, message: "Ch∆∞a c√≥ file CV" });
  }

  const cvNameError = checkLength("T√™n CV", cvName, 2, 100);
  const cvUrlError = checkLength("URL CV", cvUrl, 5, 500);

  const error = cvNameError || cvUrlError;
  if (error) {
    return res.status(400).json({ code: 400, message: error });
  }

  next();
};

module.exports = {
  checkLogin,
  checkRegister,
  checkEmailResetPassword,
  checkResetPassword,
  checkChangePassword,
  checkEditUser,
  checkMyCv,
};
```

### config\database.js
```js
const mongoose = require("mongoose");

module.exports.connect = async () => {
    try {
        await mongoose.connect(process.env.MONGO_URL);
        console.log("Connected to MongoDB");
    } catch (error) {
        console.error("Error connecting to MongoDB:", error);
    }
}

```

### helpers\generate.js
```js
module.exports.generateToken =() => {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const length = 20;
    let token = '';
  
    for (let i = 0; i < length; i++) {
      const randomIndex = Math.floor(Math.random() * characters.length);
      token += characters.charAt(randomIndex);
    }
  
    return token;
  }
module.exports.generateRandomNumber =() => {
    const characters = '0123456789';
    const length = 6;
    let result = '';
  
    for (let i = 0; i < length; i++) {
      const randomIndex = Math.floor(Math.random() * characters.length);
      result += characters.charAt(randomIndex);
    }
  
    return result;
  }
```

### helpers\sendMail.js
```js
const nodemailer = require("nodemailer");

module.exports.sendMail = (email, subject, otpCode) => {
  const transporter = nodemailer.createTransport({
    service: "gmail",
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASSWORD,
    },
  });

  const mailOptions = {
    from: process.env.EMAIL_USER,
    to: email,
    subject: subject,
    html: `
    <div style="max-width: 600px; margin: auto; border: 1px solid #eee; padding: 30px; font-family: Arial, sans-serif; background-color: #f9f9f9;">
      <div style="text-align: center; padding-bottom: 20px;">
        <h1 style="color: #2e5aac; margin-bottom: 5px;">IT JOB</h1>
        <p style="margin: 0; color: #555;">N·ªÅn t·∫£ng k·∫øt n·ªëi vi·ªác l√†m ng√†nh CNTT</p>
      </div>
      <div style="background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
        <h2 style="color: #333;">M√£ x√°c th·ª±c OTP c·ªßa b·∫°n</h2>
        <p style="font-size: 16px; color: #555;">Xin ch√†o,</p>
        <p style="font-size: 16px; color: #555;">B·∫°n ƒëang th·ª±c hi·ªán h√†nh ƒë·ªông c·∫ßn x√°c minh qua OTP. Vui l√≤ng s·ª≠ d·ª•ng m√£ d∆∞·ªõi ƒë√¢y:</p>
        <div style="text-align: center; margin: 20px 0;">
          <span style="display: inline-block; padding: 12px 24px; font-size: 24px; font-weight: bold; background-color: #2e5aac; color: #fff; border-radius: 6px;">
            ${otpCode}
          </span>
        </div>
        <p style="color: #777;">M√£ OTP n√†y s·∫Ω h·∫øt h·∫°n sau <strong>5 ph√∫t</strong>. N·∫øu b·∫°n kh√¥ng y√™u c·∫ßu m√£ n√†y, vui l√≤ng b·ªè qua email.</p>
        <p style="margin-top: 30px; color: #999;">Tr√¢n tr·ªçng,<br/>ƒê·ªôi ng≈© <strong>IT JOB</strong></p>
      </div>
      <div style="text-align: center; font-size: 12px; color: #aaa; margin-top: 30px;">
        ¬© ${new Date().getFullYear()} IT JOB. All rights reserved.
      </div>
    </div>
  `,
  };

  transporter.sendMail(mailOptions, function (error, info) {
    if (error) {
      console.log(error);
    } else {
      console.log("Email sent: " + info.response);
      // do something useful
    }
  });
};

```
